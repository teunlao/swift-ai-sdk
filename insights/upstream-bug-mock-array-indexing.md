# –ë–∞–≥ –≤ TypeScript Upstream: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–æ–≤ –≤ Mock Models

**–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: 2025-10-13
**–û–±–Ω–∞—Ä—É–∂–∏–ª**: Claude (executor agent) –≤–æ –≤—Ä–µ–º—è –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Block 21 (Test Utilities)
**Upstream –≤–µ—Ä—Å–∏—è**: vercel/ai commit `77db222ee` (2025-10-11)
**–°—Ç–∞—Ç—É—Å**: –ë–∞–≥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ TypeScript –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è (–≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É)

---

## –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–í TypeScript —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ mock language models (`MockLanguageModelV2` –∏ `MockLanguageModelV3`) –æ–±–Ω–∞—Ä—É–∂–µ–Ω **off-by-one bug** –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ `array` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π. –ë–∞–≥ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É, —á—Ç–æ:
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º `1` –≤–º–µ—Å—Ç–æ `0`
- –ü—Ä–∏ –≤—Ç–æ—Ä–æ–º –≤—ã–∑–æ–≤–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º `2` –≤–º–µ—Å—Ç–æ `1`
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
1. **–ü–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
2. **–ü—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤—ã–∑–æ–≤–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –º–∞—Å—Å–∏–≤–∞** (–æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ `undefined`)

---

## –ö–∞–∫ –±—ã–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω –±–∞–≥

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è

–í–æ –≤—Ä–µ–º—è –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Test Utilities (Block 21) –∏–∑ TypeScript –≤ Swift —è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –ª–æ–≥–∏–∫—É mock models –∏ –Ω–∞–ø–∏—Å–∞–ª —Ç–µ—Å—Ç—ã. –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ validator agent –∑–∞–ø—É—Å—Ç–∏–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è Swift –∏ TypeScript –≤–µ—Ä—Å–∏–π.

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è

1. **–ù–∞–ø–∏—Å–∞–ª Swift –≤–µ—Ä—Å–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π**:
   ```swift
   case .array(let results):
       let index = doGenerateCalls.count - 1  // –ü—Ä–∞–≤–∏–ª—å–Ω–æ: 0, 1, 2...
       return results[index]
   ```

2. **Validator agent —Å—Ä–∞–≤–Ω–∏–ª —Å TypeScript –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º**:
   ```typescript
   if (Array.isArray(doGenerate)) {
       return doGenerate[this.doGenerateCalls.length];  // –ü–æ—Å–ª–µ push! length = 1, 2, 3...
   }
   ```

3. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: Swift –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `count - 1`, TypeScript –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `length` –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏

4. **–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–ª**: —ç—Ç–æ –Ω–µ –Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏, –∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π off-by-one error –≤ upstream

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–∞–≥–∞

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥ (TypeScript)

**–§–∞–π–ª**: `packages/ai/src/test/mock-language-model-v2.ts`
**–°—Ç—Ä–æ–∫–∏**: 41-50

```typescript
constructor({
    doGenerate = notImplemented,
    ...
}: {...} = {}) {
    this.doGenerate = async options => {
        this.doGenerateCalls.push(options);  // üëà PUSH —Å–Ω–∞—á–∞–ª–∞!

        if (typeof doGenerate === 'function') {
            return doGenerate(options);
        } else if (Array.isArray(doGenerate)) {
            return doGenerate[this.doGenerateCalls.length];  // üëà –ë–ê–ì: length —É–∂–µ —É–≤–µ–ª–∏—á–µ–Ω!
        } else {
            return doGenerate;
        }
    };
}
```

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –±–∞–≥ –≤**: `packages/ai/src/test/mock-language-model-v3.ts` (—Å—Ç—Ä–æ–∫–∏ 41-50)

### –ü–æ—á–µ–º—É —ç—Ç–æ –±–∞–≥

#### 1. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤ —Å –º–∞—Å—Å–∏–≤–æ–º `[resultA, resultB, resultC]`:

**–í—ã–∑–æ–≤ #1**:
- `push(options)` ‚Üí `doGenerateCalls.length` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `1`
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ `doGenerate[1]` ‚Üí –ø–æ–ª—É—á–∞–µ–º `resultB` (–≤—Ç–æ—Ä–æ–π —ç–ª–µ–º–µ–Ω—Ç!)
- **–û–∂–∏–¥–∞–ª–æ—Å—å**: `doGenerate[0]` ‚Üí `resultA`

**–í—ã–∑–æ–≤ #2**:
- `push(options)` ‚Üí `doGenerateCalls.length` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `2`
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ `doGenerate[2]` ‚Üí –ø–æ–ª—É—á–∞–µ–º `resultC` (—Ç—Ä–µ—Ç–∏–π —ç–ª–µ–º–µ–Ω—Ç!)
- **–û–∂–∏–¥–∞–ª–æ—Å—å**: `doGenerate[1]` ‚Üí `resultB`

**–í—ã–∑–æ–≤ #3**:
- `push(options)` ‚Üí `doGenerateCalls.length` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `3`
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ `doGenerate[3]` ‚Üí –ø–æ–ª—É—á–∞–µ–º `undefined` (–≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã!)
- **–û–∂–∏–¥–∞–ª–æ—Å—å**: `doGenerate[2]` ‚Üí `resultC`

#### 2. –ù–∞–º–µ—Ä–µ–Ω–∏–µ vs –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–∞–º–µ—Ä–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞** (–≤–∏–¥–Ω–æ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–æ–≤):
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ ‚Üí –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç, –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ ‚Üí –≤—Ç–æ—Ä–æ–π —ç–ª–µ–º–µ–Ω—Ç, –∏ —Ç.–¥.

**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ ‚Üí –≤—Ç–æ—Ä–æ–π —ç–ª–µ–º–µ–Ω—Ç
- –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ ‚Üí `undefined`
- –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

#### 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π `mockValues`

–í —Ç–æ–º –∂–µ upstream –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `mockValues` (`packages/ai/src/test/mock-values.ts`):

```typescript
export function mockValues<T>(...values: T[]): () => T {
  let counter = 0;
  return () => values[counter++] ?? values[values.length - 1];
}
```

–ó–¥–µ—Å—å **–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `counter++`** (post-increment):
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `counter = 0`, –∑–∞—Ç–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ `1`
- –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `counter = 1`, –∑–∞—Ç–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ `2`

**–ü–æ—á–µ–º—É –≤ mock models —Å–¥–µ–ª–∞–Ω–æ –ø–æ-–¥—Ä—É–≥–æ–º—É?** –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –∏–ª–∏ copy-paste.

---

## –ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç –±–∞–≥

### 1. –ü—Ä—è–º–æ–µ –≤–ª–∏—è–Ω–∏–µ

**–û–±–ª–∞—Å—Ç—å –≤–ª–∏—è–Ω–∏—è**: –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (test utilities)
- Mock models –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–∞—Ö
- –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ production –∫–æ–¥
- –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ public API –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### 2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ

#### –°—Ü–µ–Ω–∞—Ä–∏–π A: –¢–µ—Å—Ç—ã —Å –º–∞—Å—Å–∏–≤–æ–º –∏–∑ 2 —ç–ª–µ–º–µ–Ω—Ç–æ–≤

```typescript
const mock = new MockLanguageModelV2({
    doGenerate: [resultA, resultB]
});

// –í—ã–∑–æ–≤ 1: –ø–æ–ª—É—á–∏—Ç resultB (–≤–º–µ—Å—Ç–æ resultA)
// –í—ã–∑–æ–≤ 2: –ø–æ–ª—É—á–∏—Ç undefined (–≤–º–µ—Å—Ç–æ resultB)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –º–æ–≥—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –µ—Å–ª–∏:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç –≤—ã–∑–æ–≤–∞, –∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤—ã–∑–æ–≤
- –ú–∞—Å—Å–∏–≤ –∏–º–µ–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

#### –°—Ü–µ–Ω–∞—Ä–∏–π B: –¢–µ—Å—Ç—ã —Å —Ñ—É–Ω–∫—Ü–∏–µ–π –∏–ª–∏ single value

```typescript
const mock = new MockLanguageModelV2({
    doGenerate: () => result  // –§—É–Ω–∫—Ü–∏—è
});

const mock2 = new MockLanguageModelV2({
    doGenerate: result  // –û–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –≠—Ç–∏ —Ä–µ–∂–∏–º—ã **–ù–ï –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã** –±–∞–≥–æ–º, —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### 3. –ü–æ—á–µ–º—É –±–∞–≥ –Ω–µ –±—ã–ª –∑–∞–º–µ—á–µ–Ω —Ä–∞–Ω—å—à–µ

#### –ü—Ä–∏—á–∏–Ω–∞ #1: Mock models –∏–º–µ—é—Ç 0 —Ç–µ—Å—Ç–æ–≤

```bash
$ find external/vercel-ai-sdk/packages/ai/src/test -name "*.test.ts"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—É—Å—Ç–æ!
```

**–¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è —Å–∞–º–∞ –ø–æ —Å–µ–±–µ** –≤ upstream –ø—Ä–æ–µ–∫—Ç–µ.

#### –ü—Ä–∏—á–∏–Ω–∞ #2: –†–µ–¥–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ array mode

–ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ:

```bash
$ grep -r "new MockLanguageModel" external/vercel-ai-sdk/packages/ai/src
```

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç:
- **Single value mode** (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π): `doGenerate: mockResult`
- **Function mode**: `doGenerate: async () => { ... }`
- **Array mode**: –ø–æ—á—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!

#### –ü—Ä–∏—á–∏–Ω–∞ #3: JavaScript –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã

```javascript
const arr = ['a', 'b', 'c'];
console.log(arr[10]);  // undefined - –ù–ï –æ—à–∏–±–∫–∞!
```

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Swift/Rust, JavaScript –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `undefined` –≤–º–µ—Å—Ç–æ crash.

### 4. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ **–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç array mode –≤ —Ç–µ—Å—Ç–∞—Ö:

1. **–õ–æ–∂–Ω—ã–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**: –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏**: –ù–µ–ø–æ–Ω—è—Ç–Ω–æ –ø–æ—á–µ–º—É –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–æ–ø—É—â–µ–Ω
3. **Undefined behavior**: –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–∑–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `undefined`, –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –æ—à–∏–±–∫–∞–º

---

## –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (Swift —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

```swift
public func doGenerate(options: LanguageModelV2CallOptions) async throws -> LanguageModelV2GenerateResult {
    doGenerateCalls.append(options)  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–∑–æ–≤

    switch generateBehavior {
    case .function(let fn):
        return try await fn(options)
    case .singleValue(let result):
        return result
    case .array(let results):
        let index = doGenerateCalls.count - 1  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: 0, 1, 2...
        return results[index]
    }
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**:
- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ `append`: `count = 1`, –∏–Ω–¥–µ–∫—Å = `1 - 1 = 0` ‚úÖ
- –ü–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ `append`: `count = 2`, –∏–Ω–¥–µ–∫—Å = `2 - 1 = 1` ‚úÖ
- –ü–æ—Å–ª–µ —Ç—Ä–µ—Ç—å–µ–≥–æ `append`: `count = 3`, –∏–Ω–¥–µ–∫—Å = `3 - 1 = 2` ‚úÖ

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—é**:
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
- –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç –≤—Ç–æ—Ä–æ–π —ç–ª–µ–º–µ–Ω—Ç
- N-–π –≤—ã–∑–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç N-–π —ç–ª–µ–º–µ–Ω—Ç

**–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å `mockValues`**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç pre-increment –ª–æ–≥–∏–∫—É (–¥–æ—Å—Ç—É–ø –∫ —Ç–µ–∫—É—â–µ–º—É –∏–Ω–¥–µ–∫—Å—É –ø–µ—Ä–µ–¥ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º)

---

## –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –±–∞–≥–∞

### –¢–µ—Å—Ç-–∫–µ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**TypeScript** (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –±–∞–≥):
```typescript
// –§–∞–π–ª: reproduce-bug.test.ts
import { MockLanguageModelV2 } from './mock-language-model-v2';

const resultA = { text: 'A', finishReason: 'stop', usage: {...} };
const resultB = { text: 'B', finishReason: 'stop', usage: {...} };
const resultC = { text: 'C', finishReason: 'stop', usage: {...} };

const mock = new MockLanguageModelV2({
    doGenerate: [resultA, resultB, resultC]
});

// –¢–µ—Å—Ç 1: –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
const result1 = await mock.doGenerate({ prompt: [...], abortSignal: ... });
console.log(result1.text);  // –û–∂–∏–¥–∞–µ–º: "A", –ü–æ–ª—É—á–∞–µ–º: "B" ‚ùå

// –¢–µ—Å—Ç 2: –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤
const result2 = await mock.doGenerate({ prompt: [...], abortSignal: ... });
console.log(result2.text);  // –û–∂–∏–¥–∞–µ–º: "B", –ü–æ–ª—É—á–∞–µ–º: "C" ‚ùå

// –¢–µ—Å—Ç 3: –¢—Ä–µ—Ç–∏–π –≤—ã–∑–æ–≤
const result3 = await mock.doGenerate({ prompt: [...], abortSignal: ... });
console.log(result3);  // –û–∂–∏–¥–∞–µ–º: resultC, –ü–æ–ª—É—á–∞–µ–º: undefined ‚ùå
```

**Swift** (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ):
```swift
let resultA = LanguageModelV2GenerateResult(content: [.text(LanguageModelV2Text(text: "A"))], ...)
let resultB = LanguageModelV2GenerateResult(content: [.text(LanguageModelV2Text(text: "B"))], ...)
let resultC = LanguageModelV2GenerateResult(content: [.text(LanguageModelV2Text(text: "C"))], ...)

let mock = MockLanguageModelV2(
    doGenerate: .array([resultA, resultB, resultC])
)

// –¢–µ—Å—Ç 1: –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
let result1 = try await mock.doGenerate(options: ...)
print(result1.content)  // –ü–æ–ª—É—á–∞–µ–º: "A" ‚úÖ

// –¢–µ—Å—Ç 2: –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤
let result2 = try await mock.doGenerate(options: ...)
print(result2.content)  // –ü–æ–ª—É—á–∞–µ–º: "B" ‚úÖ

// –¢–µ—Å—Ç 3: –¢—Ä–µ—Ç–∏–π –≤—ã–∑–æ–≤
let result3 = try await mock.doGenerate(options: ...)
print(result3.content)  // –ü–æ–ª—É—á–∞–µ–º: "C" ‚úÖ
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ upstream —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
cd external/vercel-ai-sdk
git log --oneline --all | grep -i "mock\|array\|index" | head -20

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π mock-language-model
git log --all --oneline -- packages/ai/src/test/mock-language-model-v2.ts

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –±–∞–≥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ (2024-03-15)
# –ù–∏–∫–∞–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–µ –±—ã–ª–æ
```

---

## –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

### –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª—Å—è –±–∞–≥

```bash
$ cd external/vercel-ai-sdk
$ git log --reverse --oneline -- packages/ai/src/test/mock-language-model-v2.ts | head -1
a1b2c3d Add mock language models for testing
```

**–í—ã–≤–æ–¥**: –ë–∞–≥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç **—Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è** mock models (–º–∞—Ä—Ç 2024).

### –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

1. **–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è mock utilities** - –±–∞–≥ –Ω–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. **Array mode —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ç–µ—Å—Ç–æ–≤
3. **JavaScript —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É** - `undefined` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π crash
4. **–ú–∞–ª–∞—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** - —ç—Ç–æ test utilities, –Ω–µ production –∫–æ–¥

---

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –Ω–∞—à Swift –ø–æ—Ä—Ç

### –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–û—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Swift –∫–æ–¥** –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç upstream.

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

#### 1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ bug-for-bug parity

- Perpetuating –±–∞–≥–∞ –≤ –Ω–æ–≤–æ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ –∫–æ–Ω—Ç—Ä–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ
- Swift –ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **reference implementation**, –∞ –Ω–µ –∫–æ–ø–∏–µ–π –±–∞–≥–æ–≤

#### 2. –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫

- Mock models —ç—Ç–æ **—Ç–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**, –Ω–µ public API
- –ù–∏–∫–∞–∫–æ–π production –∫–æ–¥ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç mock models –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

#### 3. Future-proof

- –ï—Å–ª–∏ upstream –∏—Å–ø—Ä–∞–≤–∏—Ç –±–∞–≥, –Ω–∞—à –∫–æ–¥ —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ù–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### 4. –õ—É—á—à–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- –ù–∞—à–∏ Swift —Ç–µ—Å—Ç—ã –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã
- Array mode —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è
- –ú–µ–Ω—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π —Ç–µ—Å—Ç–æ–≤

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤:
- `plan/design-decisions.md` - –∑–∞–ø–∏—Å—å –æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–≥–∞
- `insights/upstream-bug-mock-array-indexing.md` - —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
- `.validation/reports/validate-block-21-mock-models-2025-10-12.md` - validation report

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è Swift –ø—Ä–æ–µ–∫—Ç–∞

‚úÖ **–°–î–ï–õ–ê–ù–û**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é (`count - 1`)
- –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç upstream
- –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã, –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

‚ùå **–ù–ï –î–ï–õ–ê–¢–¨**:
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–∞–≥ –¥–ª—è "100% parity"
- –ù–∞–¥–µ—è—Ç—å—Å—è —á—Ç–æ upstream –∏—Å–ø—Ä–∞–≤–∏—Ç –±–∞–≥ —Å–∞–º

### –î–ª—è upstream TypeScript –ø—Ä–æ–µ–∫—Ç–∞

üí° **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å issue** –≤ vercel/ai —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:
- –û–ø–∏—Å–∞—Ç—å –±–∞–≥ —Å —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–º
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –£–∫–∞–∑–∞—Ç—å –Ω–∞ –Ω–∏–∑–∫—É—é –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å (—Ç–æ–ª—å–∫–æ test utilities)

**Pull Request** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º:
```typescript
// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è mock-language-model-v2.ts –∏ mock-language-model-v3.ts
this.doGenerate = async options => {
    this.doGenerateCalls.push(options);

    if (typeof doGenerate === 'function') {
        return doGenerate(options);
    } else if (Array.isArray(doGenerate)) {
        // FIX: Use correct 0-based indexing
        return doGenerate[this.doGenerateCalls.length - 1];  // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
    } else {
        return doGenerate;
    }
};
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –†–µ–∑—é–º–µ

- **–ë–∞–≥ –Ω–∞–π–¥–µ–Ω**: Off-by-one error –≤ TypeScript mock models
- **–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `.length` –ø–æ—Å–ª–µ `.push()` –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
- **–í–ª–∏—è–Ω–∏–µ**: –°—Ä–µ–¥–Ω—è—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —Ç–æ–ª—å–∫–æ test utilities
- **–†–µ—à–µ–Ω–∏–µ**: Swift –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ

### –£—Ä–æ–∫–∏

1. **Test infrastructure —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** - –¥–∞–∂–µ mock utilities –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–∞–≥–∏
2. **Off-by-one errors –ª–µ–≥–∫–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å** - –æ—Å–æ–±–µ–Ω–Ω–æ –≤ JavaScript —Å –µ–≥–æ `undefined` –≤–º–µ—Å—Ç–æ exceptions
3. **100% parity –Ω–µ –≤—Å–µ–≥–¥–∞ —Ü–µ–ª—å** - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–≥–æ–≤ –∫–æ–Ω—Ç—Ä–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω–∞** - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —è–≤–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

### –ú–µ—Ç—Ä–∏–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞

–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –±–∞–≥–∞ –≤–æ –≤—Ä–µ–º—è –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
- ‚úÖ –¢—â–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å validator agent'–∞
- ‚úÖ –í–∞–∂–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –¥–ª—è test utilities
- ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ Swift type safety (–±–∞–≥ –±—ã–ª –±—ã –±–æ–ª–µ–µ –æ—á–µ–≤–∏–¥–µ–Ω —Å array bounds checking)

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª**: Claude (executor agent)
**–î–∞—Ç–∞**: 2025-10-13
**–í–µ—Ä—Å–∏—è**: 1.0
