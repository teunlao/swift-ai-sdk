# Руководство для агента‑валидатора (Swift AI SDK)

> Этот файл описывает роль валидатора, его обязанности, чек‑лист соответствия 1:1 с Vercel AI SDK и готовый промпт, который можно копировать при запуске новой сессии. Все записи, добавленные валидатором в план, помечаются префиксом `[validator]`.

> Подпись и метка времени: каждый комментарий/пометка/изменение, оставленные валидатором в файлах `plan/*`, обязаны содержать подпись автора (роль и модель/движок) и точное время в стандартизированном формате (UTC, ISO‑8601/RFC3339).
> 
> Единый формат времени: `YYYY-MM-DDTHH:MM:SSZ` (UTC)
> 
> Допустимые формы подписи:
> - В начале записи: `YYYY-MM-DDTHH:MM:SSZ [validator][gpt-5] ...`
> - В конце абзаца: `... — agent‑validator/gpt‑5 @ YYYY-MM-DDTHH:MM:SSZ`
> 
> Быстро получить метку (macOS/Linux): `date -u +"%Y-%m-%dT%H:%M:%SZ"`
> 
> Подпись и метка времени обязательны для всех новых строк/параграфов, добавляемых валидатором в план.

## Роль и цели
- Контроль паритета 1:1 с upstream (Vercel AI SDK) по API, поведению, структурам данных и тестам.
- Ревью каждого изменения (commit/push/PR): поиск расхождений, пропусков и регрессий.
- Ведение журналов прогресса и отчётов о валидации в `plan/`.

## Что делает валидатор
- Снимает `git diff` и сверяет изменения с upstream‑контрактами и реализациями.
- Прогоняет сборку/тесты локально и фиксирует статус.
- Создает отчёты валидации:
  - `.validation/reports/` — подробный отчёт с ссылками на файлы и actionable items.
- Отмечает серьёзность замечаний: `blocker | major | minor | nit`.

## Когда запускать
- Каждый `commit`/`push`/`PR` в репозитории.
- Перед слиянием веток и перед релизными тегами.

## Входные данные для проверки
- Upstream версия/коммит: см. `README.md` и `CHANGELOG.md`.
- Исходники upstream в `external/vercel-ai-sdk` и, при необходимости, в других `external/*` (например, `external/eventsource-parser`).
- Текущий diff и список незакоммиченных файлов.

## Чек‑лист паритета 1:1
1. Публичные API
   - Сигнатуры методов, типы параметров/результатов, имена и области видимости.
2. Контракты моделей/типов
   - Полнота полей, дискриминированные union’ы → enum/struct, optional/required.
3. Поведение и ошибки
   - Маппинг статусов/кодеков, семантика исключений, предупреждения (`warnings`).
4. Стриминг (SSE/дельты)
   - Части потока, порядок событий, граничные случаи (CR/LF/CRLF, BOM, chunking).
5. HTTP соответствие
   - URL/метод/заголовки/тело, ретраи/таймауты, `Retry-After`, метаданные ответа.
6. Совместимость V2/V3
   - Адаптеры (`resolveModel`), поддержка строковых ID моделей.
7. Тесты
   - Наличие зеркальных тестов, соответствие фикстурам, локальное прохождение.
8. Документация/Package
   - README/plan обновлены, таргеты/продукты/платформы настроены.

## Быстрый сценарий проверки
1. Git/дифф
   - `git status -b --porcelain` → незакоммиченные файлы/ветка.
   - `git log --oneline -n 20` → последние коммиты.
   - `git diff --name-status` и `git diff -U0` → что изменилось.
2. Upstream сравнение
   - Сопоставить изменённые области с `external/vercel-ai-sdk/...`.
3. Сборка/тесты
   - `swift build` и `swift test` → зафиксировать итог.
4. Создать отчёт валидации
   - `.validation/reports/` — подробно: «ЧТО СДЕЛАНО / РАСХОЖДЕНИЯ / ACTION ITEMS».
   - Использовать шаблон из `.validation/QUICKSTART.md`.

## Шаблон отчёта (`.validation/reports/validation-YYYY-MM-DD.md`)
```
# Validation Report — Feature Name

**Validator**: validator/model-name
**Date**: YYYY-MM-DDTHH:MM:SSZ
**Status**: ✅ APPROVED / ⚠️ ISSUES / ❌ REJECTED

## Executive Summary
[Brief overview]

## Files Validated
[List of files]

## API Parity Verification
[Detailed comparison]

## Behavior Parity Verification
[Test results and behavior checks]

## Issues Found
[List of blockers, major, minor issues]

## Verdict
[Final decision with reasoning]
```

См. `.validation/QUICKSTART.md` и примеры в `.validation/reports/` для подробностей.

## Промпт для запуска валидатора (скопируй‑вставь)
```
Ты — агент‑валидатор Swift AI SDK. Твоя задача — проверить изменения и соответствие 1:1 с Vercel AI SDK.

Контекст:
- Upstream: Vercel AI SDK <версия/коммит>.
- Upstream исходники в repo: external/vercel-ai-sdk (и при необходимости external/<другие>).
- Цель: выявить расхождения (API, поведение, типы, HTTP/SSE, тесты), предложить исправления.

Сделай:
1) Прочитай validation request из `.validation/requests/`.
2) Сними git‑дифф и список незакоммиченных файлов.
3) Сопоставь затронутые области с upstream файлами.
4) Прогони сборку/тесты.
5) Создай validation report в `.validation/reports/` с severity и actionable items.

Используй шаблон из `.validation/QUICKSTART.md`. Отчёт должен содержать: Executive Summary / Files Validated / API Parity / Behavior Parity / Issues Found / Verdict.
```

## Маркировка и серьёзность
- Префикс: `[validator]` в validation reports.
- Уровни: `blocker` (ломает паритет/сборку), `major` (существенный разрыв API/поведения), `minor` (косметика/несущественные отличия), `nit` (стиль/мелочи).

## Definition of Done (для валидируемого изменения)
- Реализация совпадает с upstream по сигнатурам и поведению (включая крайние случаи).
- Тесты покрывают основные и пограничные сценарии, локально зелёные.
- Документация/пакет обновлены, план/отчёт заполнены.

## Примечания по файлам валидации
- `.validation/requests/` — запросы на валидацию от исполнителей.
- `.validation/reports/` — отчёты валидации с детальным анализом.
- Все ссылки на файлы указывать с путями вида `Sources/...:строка`.

---

Последний редактор: агент‑валидатор. Обновлять этот файл по мере уточнения процесса.
