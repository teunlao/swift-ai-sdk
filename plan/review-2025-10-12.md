# Отчёт валидации — 2025-10-12
> Документ составлен агентом-валидатором для исполнителя.  
> Время отчёта (UTC): 2025-10-12T14:48:59Z

## Сводка
- Коммиты/ветка: `main` (локально без незакоммиченных изменений).
- Сборка/тесты: `SWIFTPM_MODULECACHE_OVERRIDE=$PWD/.build/modulecache swift test` → PASS (242/242).

## Что сделано (валидировано)
- Сверил `JSONValue` и набор ошибок (`Sources/SwiftAISDK/Provider/JSONValue/*.swift`, `Sources/SwiftAISDK/Provider/Errors/*.swift`) с `packages/provider/src/**` — API и сообщения соответствуют.
- Прошёл все типы `LanguageModelV2`/`LanguageModelV3` (контент, стримы, warnings, tool-контракты) и сравнил с `packages/provider/src/language-model/{v2,v3}/**`. Выявлены отличия по структуре промптов (см. ниже).
- Проверил `ProviderUtils` (ID, delay, headers, resolve, fetch-error, secure-json-parse, user-agent) против `packages/provider-utils/src/**`.
- Сопоставил порт `EventSourceParser` (`Sources/EventSourceParser/*`) с `external/eventsource-parser/src/*`; тесты `EventSourceParserTests` закрывают сценарии из upstream.

## Расхождения vs upstream
- [resolved major] `LanguageModelV2Message.user` и `LanguageModelV3Message.user` теперь принимают только `[LanguageModelV{2,3}UserMessagePart]` (text/file); декодер валидирует и отклоняет reasoning/tool для роли user. См. `Sources/SwiftAISDK/Provider/LanguageModel/V2/LanguageModelV2Prompt.swift:31-156`, `Sources/SwiftAISDK/Provider/LanguageModel/V3/LanguageModelV3Prompt.swift:31-160`, тесты `LanguageModelV{2,3}PromptTests.swift`.
- [resolved major] `withUserAgentSuffix` нормализует ключи в нижний регистр и обновляет существующий `user-agent`, полностью повторяя поведение `Headers`. См. `Sources/SwiftAISDK/ProviderUtils/WithUserAgentSuffix.swift:12-27`, тест `UserAgentTests.testCaseSensitiveHeaders`.
- [resolved minor] `getRuntimeEnvironmentUserAgent` реализует снимок окружения по тем же правилам, что и TypeScript, включая fallback `runtime/unknown` и поддержку передаваемого контекста. См. `Sources/SwiftAISDK/ProviderUtils/GetRuntimeEnvironmentUserAgent.swift:9-62`, `UserAgentTests` кейсы для browser/navigator/node/edge.

## Примечания
- Тесты требуют локального `SWIFTPM_MODULECACHE_OVERRIDE` из-за прав на user-level cache; стоит добавить подсказку в README/plan, чтобы избежать ложных сбоев у других исполнителей.
