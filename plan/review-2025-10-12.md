# Отчёт валидации — 12 октября 2025

> Этот документ составлен агентом‑валидатором. Его заметки предназначены для исполнителя (реализующего агента) как руководство по исправлению расхождений и дальнейшим шагам.

Документ фиксирует текущее состояние реализации Swift AI SDK относительно Vercel AI SDK (6.0.0-beta.42, commit 77db222e…). Служит как список расхождений и actionable items для исправления.

## Глобально
- Статус: ранний этап. Базовые типы и один тест готовы; каркасы V2 и резолвера частично набросаны.
- Git: часть новых файлов не закоммичена (риск потери работы).
- Документация: README частично неактуален.

## Контракты LanguageModel V2

Источники upstream: `external/vercel-ai-sdk/packages/provider/src/language-model/v2/*`.

Обнаруженные расхождения:
- `LanguageModelV2` (Sources/SwiftAISDK/Provider/LanguageModel/V2/LanguageModelV2.swift:1)
  - [ ] Нет `supportedUrls` (обязательное поле; Promise/Record). Требуется добавить API для объявления поддерживаемых URL по медиа‑типам.
  - [ ] `doGenerate` возвращает упрощённый результат: отсутствуют `warnings`, `request{body?}`, `response{headers?, body?, id?, timestamp?, modelId?}`. В TS это строгий объект с метаданными и предупреждениями.
  - [ ] `doStream` должен возвращать контейнер `{ stream, request?, response? }`, а не только поток.
- `LanguageModelV2CallOptions`
  - [ ] В Swift сейчас есть только `prompt: String?`. Требуется полное соответствие: `prompt (LanguageModelV2Prompt)`, `maxOutputTokens`, `temperature`, `stopSequences`, `topP`, `topK`, `presencePenalty`, `frequencyPenalty`, `responseFormat {text|json+schema(name?,description?,schema?)}`, `seed`, `tools`, `toolChoice`, `includeRawChunks`, `headers`, `providerOptions`.
- `LanguageModelV2Usage`
  - [ ] В TS: `inputTokens?`, `outputTokens?`, `totalTokens?`, `reasoningTokens?`, `cachedInputTokens?`. В Swift сейчас все три обязательные и отсутствуют 2 доп. поля.
- `LanguageModelV2StreamPart`
  - [ ] В TS — дискриминированный union: включает `stream-start{warnings}`, `response-metadata & LanguageModelV2ResponseMetadata`, `finish{usage,finishReason,providerMetadata?}`, `raw{rawValue}`, `error{error}`, а также структурированный контент (`LanguageModelV2Text/Reasoning/File/Source/ToolCall/ToolResult`). В Swift часть вариантов отсутствует и поля упрощены.
- Отсутствующие типы (все требуются):
  - [ ] `LanguageModelV2Content`, `LanguageModelV2Text`, `LanguageModelV2Reasoning`, `LanguageModelV2File`, `LanguageModelV2Source`, `LanguageModelV2ToolCall`, `LanguageModelV2ToolResult`.
  - [ ] `LanguageModelV2ResponseMetadata` (`id?`, `timestamp?`, `modelId?`).
  - [ ] `LanguageModelV2CallWarning` (unsupported-setting/tool/other).
  - [ ] `LanguageModelV2Prompt`.
  - [ ] `LanguageModelV2FunctionTool`, `LanguageModelV2ProviderDefinedTool`, `LanguageModelV2ToolChoice`.

Action items:
- Расширить `LanguageModelV2CallOptions` до паритета; обновить `Usage` (optional + доп. поля);
  добавить недостающие типы и варианты потоков; обновить сигнатуры `doGenerate/doStream`.
- Добавить `supportedUrls` в протокол `LanguageModelV2`.

## Resolve Model (V2→V3 и строковые модели)

Upstream: `external/vercel-ai-sdk/packages/ai/src/model/resolve-model.ts`.

Обнаруженные расхождения:
- `Sources/SwiftAISDK/Core/Model/ResolveModel.swift:1` — резолвер возвращает вход без проверки версии и без адаптера.
- В TS:
  - [ ] Проверка `specificationVersion` ∈ {`v2`,`v3`} с выбросом `UnsupportedModelVersionError` в ином случае.
  - [ ] Адаптер: `v2` оборачивается прокси, который отдаёт `'v3'` для `specificationVersion`.
  - [ ] Строковые модели: при `string` используется глобальный провайдер для резолва модели по ID.

Action items:
- Реализовать адаптер V2→V3 (proxy или тонкий wrapper) и валидацию версии.
- Предусмотреть разрешение строкового ID через глобальный провайдер (пока можно заглушку с TODO).
- Добавить Swift‑ошибку `UnsupportedModelVersionError`.

## SSE/HTTP слой

План: `plan/http-architecture.md`.

Состояние (обновлено [validator 2025‑10‑12]):
- Добавлен модуль `EventSourceParser` — перенос `eventsource-parser@3.0.6`:
  - `Sources/EventSourceParser/Parser.swift` — парсер (anchored BOM, ASCII `retry`, CRLF на границе чанков).
  - `Sources/EventSourceParser/Types.swift` — `EventSourceMessage`, ошибки и коллбеки.
  - `Sources/EventSourceParser/Stream.swift` — конвертация `AsyncThrowingStream<Data, Error>` → `AsyncThrowingStream<EventSourceMessage, Error>`.
  - Тесты: `Tests/EventSourceParserTests/*` — базовые сценарии и пограничные случаи.
  - Интеграция в пакет: `Package.swift` содержит таргет и тест‑таргет `EventSourceParser`.

Обновления [validator 2025‑10‑12]:
- Добавлены `EventSourceParserStreamOptions` с режимами ошибок (.ignore | .terminate | .custom) и коллбэками `onRetry`/`onComment`.
- В `reset(consume:)` сбрасывается trailing‑CR флаг.
- При `.terminate` чтение входного потока аккуратно останавливается через флаг‑актер.

Оставшиеся задачи:
- Далее по плану: реализовать `HTTPClient` + interceptors (ещё не начато).

## README/Документация

Обнаруженные расхождения:
- `README.md` содержит «Implementation has not started yet», что не соответствует текущему состоянию.

Action items:
- Обновить статус и добавить минимальный пример использования API (можно временно на мок‑провайдере).
- Закрепить upstream ссылку (версия/commit) и цели паритета.

## Package/Таргеты

Сейчас:
- `Package.swift`: добавлена `.macOS(.v11)`, единый таргет. План предполагает модульность.

Action items:
- Принять решение по платформам (iOS/tvOS/watchOS/Linux) и наметить разбиение на `Core`, `Provider`, `ProviderUtils`.

## Git/Хозяйственные пометки

- Незакоммиченные файлы (риск):
  - `Sources/SwiftAISDK/Core/Model/ResolveModel.swift`
  - `Sources/SwiftAISDK/Provider/LanguageModel/V2/LanguageModelV2.swift`
  - `Sources/SwiftAISDK/Provider/JSONValue/JSONValue.swift`
  - `Sources/SwiftAISDK/Provider/Shared/V2/SharedV2Types.swift`
  - `Sources/SwiftAISDK/ProviderUtils/SSE/ServerSentEvent.swift`
  - `Tests/SwiftAISDKTests/JSONValueTests.swift`

Action items:
- Закоммитить текущие наработки отдельным коммитом «feat(core/provider): bootstrap V2 contracts + JSONValue + resolver stub».
- Далее — мелкие, атомарные PR по блокам (V2 options, V2 stream parts, resolver adapter, SSE parser и т.п.).

---

Последующее обновление этого файла — при каждом валидаторском проходе, с датой и краткой сводкой изменений/замечаний.
