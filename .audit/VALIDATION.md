# Руководство по Валидации: Проверка 100% Соответствия Upstream

## Назначение

Этот документ описывает процесс валидации для проверки того, что Swift-реализация поддерживает **100% функциональное соответствие** с upstream TypeScript Vercel AI SDK.

---

## Область Валидации

### Что Проверяем

1. **API Интерфейс** - Публичные интерфейсы, методы, типы
2. **Поведение** - Поведение во время выполнения, граничные случаи, обработка ошибок
3. **Покрытие Тестами** - Все upstream тесты портированы и проходят
4. **Документация** - Заголовки ссылаются на upstream источники

### Что НЕ Проверяем

- Детали реализации (внутренняя структура может отличаться)
- Характеристики производительности (Swift vs TypeScript)
- Платформо-специфичные адаптации (документированы в `plan/design-decisions.md`)

---

## Процесс Валидации

### Шаг 1: Определить Upstream Референс

**Расположение**: `external/vercel-ai-sdk/packages/`

**Соответствие Пакетов**:
```
TypeScript                          →  Swift Target
external/.../provider/src/          →  Sources/AISDKProvider/
external/.../provider-utils/src/    →  Sources/AISDKProviderUtils/
external/.../ai/src/                →  Sources/SwiftAISDK/
```

**Найти Исходники**:
```bash
# Пример: Поиск утилиты delay
ls external/vercel-ai-sdk/packages/provider-utils/src/delay.ts
ls external/vercel-ai-sdk/packages/provider-utils/src/delay.test.ts
```

### Шаг 2: Проверка Соответствия API

**Чеклист Публичного Интерфейса**:

- [ ] **Сигнатуры функций совпадают**
  - Имена параметров (адаптированы под Swift конвенции)
  - Типы параметров (адаптированы через type mappings)
  - Возвращаемые типы (Promise → async throws)
  - Опциональные параметры (? → = nil)

- [ ] **Типы совпадают**
  - Enum с теми же значениями
  - Struct/класы с теми же свойствами
  - Union types → Swift enum с associated values

- [ ] **Обработка ошибок совпадает**
  - Те же типы ошибок
  - Те же сообщения об ошибках (точный текст)
  - Те же условия выброса ошибок

**Пример Сравнения**:

```typescript
// TypeScript (upstream)
export async function delay(
  delayInMs: number,
  options?: { signal?: AbortSignal }
): Promise<void>
```

```swift
// Swift (портированный)
public func delay(
    delayInMs: Int,
    signal: (@Sendable () -> Bool)? = nil
) async throws
```

✅ **Соответствие сохранено**:
- Имена параметров: совпадают
- Типы: number → Int, AbortSignal → @Sendable closure
- Возврат: Promise<void> → async throws
- Опциональность: options? → параметр по умолчанию

### Шаг 3: Проверка Соответствия Поведения

**Протестировать Каждый Upstream Сценарий**:

1. **Прочитать upstream тесты**:
   ```bash
   cat external/vercel-ai-sdk/packages/provider-utils/src/delay.test.ts
   ```

2. **Портировать ВСЕ тест-кейсы**:
   - Те же имена тестов (адаптированы в camelCase)
   - Те же тестовые данные
   - Те же проверки (assertions)
   - Те же граничные случаи

3. **Проверить совпадение поведения**:
   ```bash
   swift test --filter DelayTests
   ```

**Требования к Покрытию Тестами**:

| Upstream | Swift | Статус |
|----------|-------|--------|
| 100% | 100% | ✅ Требуется |
| 100% | 90% | ❌ Отклонено |
| 100% | 110% | ✅ Допустимо (дополнительные Swift-специфичные тесты OK) |

### Шаг 4: Построчный Разбор Реализации

**Для каждой функции/метода**:

1. **Прочитать TypeScript реализацию**
2. **Сравнить со Swift построчно**
3. **Проверить отсутствующую логику**:
   - Условные ветвления
   - Итерации циклов
   - Ранние возвраты
   - Значения по умолчанию

**Пример**:

```typescript
// Upstream: delay.ts
if (options?.signal?.aborted) {
  throw new AbortError();
}
```

```swift
// Swift: Delay.swift
if signal?() == true {
    throw AISDKProviderUtilsError.aborted
}
```

✅ **Соответствие**: Оба проверяют условие отмены перед задержкой

### Шаг 5: Валидация Граничных Случаев

**Обязательные Граничные Случаи**:

- [ ] **Обработка null/nil**
  - undefined → nil
  - Поведение optional chaining совпадает

- [ ] **Пустые коллекции**
  - Пустые массивы/словари
  - Строки нулевой длины

- [ ] **Граничные значения**
  - Мин/макс целые числа
  - Ноль, отрицательные числа
  - Очень большие значения

- [ ] **Условия ошибок**
  - Невалидный вход
  - Сетевые сбои (для HTTP кода)
  - Таймауты/отмены

- [ ] **Конкурентный доступ** (если применимо)
  - Потокобезопасность
  - Race conditions

### Шаг 6: Валидация Документации

**Обязательно в каждом файле**:

```swift
/**
 Краткое описание функциональности.

 Порт `@ai-sdk/provider-utils/src/delay.ts`.

 Адаптации:
 - AbortSignal → @Sendable () -> Bool для Swift concurrency
 */
```

**Проверка**:
- [ ] Заголовок присутствует
- [ ] Upstream путь указан
- [ ] Адаптации задокументированы (если есть)

---

## Шаблон Чеклиста Валидации

Используйте для каждой валидации модуля/пакета:

### Модуль: `<НазваниеМодуля>`
**Upstream**: `external/.../packages/<package>/src/<module>.ts`
**Swift**: `Sources/<Target>/<Module>.swift`

#### Соответствие API
- [ ] Все публичные функции портированы
- [ ] Все публичные типы портированы
- [ ] Сигнатуры параметров совпадают (адаптированы)
- [ ] Возвращаемые типы совпадают (адаптированы)
- [ ] Типы ошибок совпадают

#### Соответствие Поведения
- [ ] Все upstream тесты портированы
- [ ] Имена тестов совпадают (camelCase)
- [ ] Тестовые данные совпадают
- [ ] Проверки (assertions) совпадают
- [ ] Граничные случаи покрыты

#### Разбор Реализации
- [ ] Построчное сравнение выполнено
- [ ] Все условные ветки присутствуют
- [ ] Все циклы/итерации присутствуют
- [ ] Обработка ошибок полная
- [ ] Значения по умолчанию корректны

#### Граничные Случаи
- [ ] Обработка Nil/undefined
- [ ] Пустые коллекции
- [ ] Граничные значения
- [ ] Условия ошибок
- [ ] Конкурентность (если применимо)

#### Документация
- [ ] Заголовок файла присутствует
- [ ] Upstream референс включен
- [ ] Адаптации задокументированы

#### Тестирование
- [ ] `swift build` успешен
- [ ] `swift test --filter <ModuleTests>` проходит
- [ ] Покрытие: ___/___  (требуется 100%)

---

## Типичные Ошибки при Валидации

### 1. Пропущенные Граничные Случаи

**Ошибка**: Upstream тестирует 10 сценариев, Swift только 8

**Исправление**:
```bash
# Найти пропущенные тесты
diff <(grep "it('should" upstream.test.ts) \
     <(grep "@Test" Tests/Module.swift)
```

### 2. Неправильные Type Mappings

**Ошибка**: Использование `String?` когда upstream использует `undefined | string`

**Проблема**: В TypeScript `undefined` это НЕ то же самое что `null`

**Исправление**: Используйте `Optional<String>` (nil в Swift = undefined в TS)

### 3. Разные Сообщения об Ошибках

**Ошибка**:
- Upstream: `"Invalid model ID"`
- Swift: `"Model ID is invalid"`

**Исправление**: Скопировать точный текст ошибки из upstream

### 4. Отсутствующая Документация Адаптаций

**Ошибка**: Заголовок файла без заметок об адаптациях

**Исправление**: Всегда документировать TypeScript → Swift адаптации:
```swift
/**
 Адаптации:
 - Promise<T> → async throws -> T
 - AbortSignal → @Sendable () -> Bool
 */
```

### 5. Неполное Покрытие Тестами

**Ошибка**: Портирована функция, но только 50% тестов

**Исправление**: Портировать ВСЕ тесты из файла `.test.ts`:
```bash
# Подсчет upstream тестов
grep -c "it('should" delay.test.ts  # 6 тестов

# Подсчет Swift тестов
grep -c "@Test" DelayTests.swift    # Должно быть >= 6
```

---

## Инструменты Валидации

### 1. Автоматический Test Runner

**Расположение**: `tools/test-runner.js`

**Использование**:
```bash
# Запустить все тесты
node tools/test-runner.js

# Smart mode - обнаружение race conditions
node tools/test-runner.js --smart --runs 5

# Тестировать конкретный suite
swift test --filter OpenAIChatLanguageModelTests
```

### 2. Отслеживание Покрытия

**Расположение**: `Audit.md`

**Обновить после валидации**:
```markdown
| Модуль | Upstream | Swift | Покрытие | Статус |
|--------|----------|-------|----------|--------|
| Delay | 6 тестов | 6 тестов | 100% | ✅ ЗАВЕРШЕНО |
```

### 3. Git История

**Проверить предыдущие валидации**:
```bash
git log --grep="validation" --oneline
git show <commit> -- Audit.md
```

---

## Workflow Валидации

### Для Исполнителей (Executors)

1. **Реализовать** модуль из upstream
2. **Портировать ВСЕ тесты** из `.test.ts`
3. **Запустить тесты**: `swift test --filter <Module>Tests`
4. **Само-валидация** используя чеклист выше
5. **Создать запрос валидации**: `.orchestrator/requests/validate-*.md`
6. **Обновить flow JSON**: `status="ready_for_validation"`

### Для Валидаторов (Validators)

1. **Прочитать запрос валидации исполнителя**
2. **Следовать этому VALIDATION.md руководству**
3. **Использовать шаблон чеклиста** выше
4. **Запустить тесты самостоятельно**: `swift build && swift test`
5. **Построчное сравнение** с upstream
6. **Написать детальный отчет**: `.orchestrator/reports/validate-*-report.md`
7. **Вердикт**:
   - ✅ **Одобрено**: 100% соответствие подтверждено
   - ❌ **Отклонено**: Перечислить ВСЕ несоответствия с номерами строк

### Критерии Отклонения

**Отклонить если ЛЮБОЕ из этого верно**:

- [ ] Отсутствует ЛЮБОЙ upstream тест
- [ ] Тест падает
- [ ] Несоответствие сигнатуры API
- [ ] Разные сообщения об ошибках
- [ ] Отсутствует обработка граничного случая
- [ ] Нет upstream референса в заголовке
- [ ] Недокументированные адаптации
- [ ] Разное поведение на одинаковом входе

**Одобрять только когда**: 100% соответствие подтверждено по ВСЕМ пунктам чеклиста.

---

## Примеры

### Пример 1: Полный Отчет о Валидации

```markdown
# Отчет о Валидации: Модуль Delay

**Исполнитель**: executor-1760450655037
**Модуль**: AISDKProviderUtils/Delay
**Upstream**: external/.../provider-utils/src/delay.ts

## Соответствие API ✅
- функция delay(): сигнатура совпадает (адаптирован AbortSignal)

## Соответствие Поведения ✅
- Все 6 upstream тестов портированы
- Имена тестов совпадают
- Проверки (assertions) верифицированы

## Реализация ✅
- Построчное сравнение завершено
- Проверка abort присутствует
- Логика задержки совпадает

## Граничные Случаи ✅
- Обработка nil signal: корректно
- Нулевая задержка: работает
- Отрицательная задержка: выбрасывает ошибку (совпадает с upstream)
- Abort во время задержки: выбрасывает AbortError

## Документация ✅
- Заголовок присутствует с upstream референсом
- Адаптация задокументирована (AbortSignal → closure)

## Тестирование ✅
- swift build: УСПЕХ
- swift test --filter DelayTests: 6/6 ПРОШЛИ
- Покрытие: 6/6 (100%)

**ВЕРДИКТ**: ✅ ОДОБРЕНО
```

### Пример 2: Отчет об Отклонении

```markdown
# Отчет о Валидации: OpenAIChatLanguageModel

**ВЕРДИКТ**: ❌ ОТКЛОНЕНО

## Найденные Проблемы

### 1. Отсутствующие Тесты (КРИТИЧНО)
**Критичность**: БЛОКЕР
**Расположение**: Tests/SwiftAISDKTests/OpenAI/OpenAIChatLanguageModelTests.swift

Upstream содержит 71 тест, Swift имеет только 18 тестов (25.4% покрытие).

**Отсутствующие сценарии**:
- Stream text deltas (10 тестов)
- Service tier processing (6 тестов)
- Search model handling (3 теста)
- Extension settings (6 тестов)

**Требуется**: Портировать ВСЕ 53 отсутствующих теста.

### 2. Несоответствие Сообщения об Ошибке
**Критичность**: ВАЖНО
**Расположение**: OpenAIChatLanguageModel.swift:245

**Ожидается** (upstream):
```
"temperature is not supported for the search preview models and has been removed."
```

**Фактически** (Swift):
```
"temperature not supported"
```

**Исправление**: Использовать точный текст ошибки из upstream.

### 3. Отсутствующий Граничный Случай
**Критичность**: ВАЖНО
**Расположение**: Tests строка 1050

**Отсутствует**: Тест для пустого chunk после tool call

**Upstream**: openai-chat-language-model.test.ts:892
```typescript
it('should handle empty chunk after tool call', ...)
```

**Требуется**: Портировать этот тест-кейс.

## Требуемые Действия

1. Добавить 53 отсутствующих теста
2. Исправить сообщение об ошибке на строке 245
3. Добавить тест пустого chunk
4. Перезапустить полный набор тестов
5. Запросить новую валидацию

**Статус**: needs_fix
```

---

## Быстрая Справка

**Команда Валидации**:
```bash
swift build && swift test --filter <ModuleTests>
```

**Формула Соответствия**:
```
Соответствие = (Swift Тесты / Upstream Тесты) × 100%
Требуется: 100%
```

**Критерии Одобрения**:
```
✅ Все тесты портированы
✅ Все тесты проходят
✅ API совпадает (адаптирован)
✅ Поведение совпадает
✅ Документация полная
✅ Нет блокеров/критичных проблем
```

**Файлы для Проверки**:
1. Реализация: `Sources/<Target>/<Module>.swift`
2. Тесты: `Tests/<Target>Tests/<Module>Tests.swift`
3. Upstream: `external/.../packages/<pkg>/src/<module>.ts`
4. Upstream Тесты: `external/.../packages/<pkg>/src/<module>.test.ts`

---

**Последнее Обновление**: 2025-10-20
**Validator Agent**: `.claude/agents/validator.md`
**Руководство по Автоматизации**: `plan/orchestrator-automation.md`
